document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug');

    if (!slug) {
        console.error("æœªæä¾›æ–‡ç«  slug");
        document.getElementById('post-content').innerHTML = "<p>æ‰¾ä¸åˆ°æ–‡ç« è­˜åˆ¥ç¢¼ã€‚</p>";
        return;
    }

    // ğŸ’¡ åŒæ™‚ç™¼èµ·è«‹æ±‚ï¼Œæé«˜è¼‰å…¥æ•ˆç‡
    Promise.all([
        fetch('posts/posts.json').then(res => {
            if (!res.ok) throw new Error("ç„¡æ³•è®€å–æ–‡ç« æ¸…å–®");
            return res.json();
        }),
        fetch(`posts/${slug}.md`).then(res => {
            if (!res.ok) throw new Error("ç„¡æ³•è®€å–æ–‡ç« å…§å®¹");
            return res.text();
        })
    ])
    .then(([posts, mdText]) => {
        // 1. æ ¹æ“š slug æ‰¾åˆ° JSON ä¸­å°æ‡‰çš„å…ƒæ•¸æ“š
        const currentPost = posts.find(p => p.slug === slug);
        
        if (currentPost) {
            document.getElementById('post-title').innerText = currentPost.title;
            document.getElementById('post-date').innerText = currentPost.date;
            // åŒæ­¥æ›´æ–°ç€è¦½å™¨åˆ†é æ¨™ç±¤çš„æ¨™é¡Œ
            document.title = `${currentPost.title} | Kirsten's Blog`;
        } else {
            console.warn("åœ¨ JSON ä¸­æ‰¾ä¸åˆ°å°æ‡‰çš„ slugï¼Œå°‡å˜—è©¦è§£æ Markdown æ¨™é¡Œ");
        }

        // 2. æ¸…ç† Markdown å…§å®¹ä¸¦æ¸²æŸ“
        // ç§»é™¤ Front Matter (--- ä¹‹é–“çš„å…§å®¹)
        const cleanMd = mdText.replace(/^---[\s\S]+?---/, '').trim();
        
        if (typeof marked !== 'undefined') {
            document.getElementById('post-content').innerHTML = marked.parse(cleanMd);
        } else {
            console.error("Marked å‡½å¼åº«æœªè¼‰å…¥");
        }
    })
    .catch(err => {
        console.error("è®€å–æ–‡ç« æ™‚ç™¼ç”ŸéŒ¯èª¤:", err);
        document.getElementById('post-content').innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <p>æŠ±æ­‰ï¼Œç„¡æ³•è¼‰å…¥æ–‡ç« å…§å®¹ã€‚</p>
                <a href="index.html">è¿”å›é¦–é </a>
            </div>
        `;
    });
});
